var canvasWidth,canvasHeight,selectedCropArea,canvasImageFront,canvasImageBack,copyCanvasImageFront,copyCanvasImageBack,cropAreaControlsVisibility,workspace=document.getElementById("workspace"),canvas=new fabric.Canvas("workspace",{selection:!1}),cropAreas=[],imageFormat="png",cropAreaWidth=100,cropAreaHeight=100,cropAreaColor="red",cropAreaOpacity=.4,isFrontSelected=!0,isFrontAndBack=!1,croppedImages=[],displayCropResults=!0;class MultiCrop{constructor(e){this.loadWorkspace(e)}async createWorkspace(e){var t=document.getElementsByClassName("workspace-container")[0],a=document.createElement("div");a.setAttribute("id","crop-modal"),a.setAttribute("class","display-crop-container"),document.createElement("span").setAttribute("class","display-crop-container");var n=document.createElement("span");n.setAttribute("class","close-display material-icons"),n.setAttribute("onclick","closeDisplayModal()"),n.appendChild(document.createTextNode("close"));var o=document.createElement("div");o.setAttribute("id","crop-image-display"),a.appendChild(n),a.appendChild(o);var c=document.createElement("div");c.setAttribute("id","workspace-area"),c.setAttribute("class","workspace-area");var i=document.createElement("textarea");i.setAttribute("id","dev-area"),i.setAttribute("class","workspace-dev-area"),i.style.width=e.width?`${e.width}px`:"100%";var r=document.createElement("div");r.setAttribute("class","workspace-loading");var s=document.createElement("div");s.setAttribute("class","lds-ellipsis"),s.appendChild(document.createElement("div")),s.appendChild(document.createElement("div")),s.appendChild(document.createElement("div")),s.appendChild(document.createElement("div")),r.appendChild(s);var d=document.createElement("canvas");d.setAttribute("id","workspace"),c.appendChild(r),c.appendChild(d);var l=document.createElement("div");l.setAttribute("class","workspace-options");var p=document.createElement("div");p.setAttribute("id","workspace-options"),p.setAttribute("class","options-row");var m=e&&e.disableButtons?e.disableButtons:[];if(m.indexOf("add-image")<0){var g=this.createButton("file-selection","btn-multicrop","add_a_photo","Carregar imagem");p.appendChild(g);var u=document.createElement("input");u.setAttribute("id","input-file-selection"),u.setAttribute("type","file"),u.style.display="none",u.addEventListener("change",function(t){loadImage(u,e.imageUploadEvent)}),g.addEventListener("click",function(e){u&&u.click()},!1),p.appendChild(u)}m.indexOf("add-crop")<0&&p.appendChild(this.createButton("add-crop","btn-multicrop","crop_free","Adicionar recorte","addRectangle()")),m.indexOf("remove-crop")<0&&p.appendChild(this.createButton("remove-crop","btn-multicrop","delete","Remover recorte","removeRectangle()")),m.indexOf("crop-all")<0&&p.appendChild(this.createButton("crop","btn-multicrop","crop","Aplicar recorte","crop()")),l.appendChild(p);var v=document.createElement("div");v.setAttribute("class","workspace-results");var h=document.createElement("div");h.setAttribute("id","crop-links"),h.setAttribute("class","options-row"),v.appendChild(h);var b=document.createElement("div");b.setAttribute("id","workspace-switch"),b.setAttribute("class","options-row");var y=document.createTextNode("Frente"),A=document.createElement("button");A.appendChild(y),A.setAttribute("class","btn-front btn-switched"),A.setAttribute("type","button"),A.addEventListener("click",function(e){const t=document.getElementsByClassName("btn-back")[0];t&&t.classList.remove("btn-switched"),e.target.classList.add("btn-switched"),isFrontSelected=!0,switchCropAreas(),switchImages()},!1);var C=document.createTextNode("Verso"),I=document.createElement("button");I.appendChild(C),I.setAttribute("class","btn-back"),I.setAttribute("type","button"),I.addEventListener("click",function(e){const t=document.getElementsByClassName("btn-front")[0];t&&t.classList.remove("btn-switched"),e.target.classList.add("btn-switched"),isFrontSelected=!1,switchCropAreas(),switchImages()},!1),b.appendChild(A),b.appendChild(I),t.appendChild(a),t.appendChild(c),e.devMode&&t.appendChild(i),e.isFrontAndBack&&t.appendChild(b),t.appendChild(l),e.displayCropResults&&t.appendChild(v),workspace=document.getElementById("workspace"),canvas=new fabric.Canvas("workspace",{selection:!1})}loadWorkspace(e){this.createWorkspace(e).then(()=>{if(e){if(canvasWidth=e.width?e.width:1024,canvasHeight=e.height?e.height:512,cropAreaWidth=e.defaultCropAreaWidth?e.defaultCropAreaWidth:100,cropAreaHeight=e.defaultCropAreaHeight?e.defaultCropAreaHeight:100,cropAreaColor=e.cropAreaColor?e.cropAreaColor:"red",cropAreaOpacity=e.cropAreaOpacity?e.cropAreaOpacity:.4,null!=e.isFrontAndBack&&(isFrontAndBack=e.isFrontAndBack),canvas.setWidth(canvasWidth),canvas.setHeight(canvasHeight),null!=e.displayCropResults&&(displayCropResults=e.displayCropResults),e.initialCropAreas){if(e.cropAreaControlsVisibility){var t=e.cropAreaControlsVisibility;cropAreaControlsVisibility={bl:null==t.bottomLeft||t.bottomLeft,br:null==t.bottomRight||t.bottomRight,mb:null==t.middleBottom||t.middleBottom,ml:null==t.middleLeft||t.middleLeft,mr:null==t.middleRight||t.middleRight,mt:null==t.middleTop||t.middleTop,tl:null==t.topLeft||t.topLeft,tr:null==t.topRight||t.topRight,mtr:null==t.rotationPoint||t.rotationPoint}}e.initialCropAreas.map(e=>{if(e.width>0&&e.height>0){var t=new fabric.Rect({left:e.x,top:e.y,fill:cropAreaColor,width:e.width,height:e.height,opacity:cropAreaOpacity,selectable:!0});cropAreaControlsVisibility&&t.setControlsVisibility(cropAreaControlsVisibility),t.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{name:this.name,isFront:this.isFront,originalOpacity:this.originalOpacity})}}(t.toObject),t.name=e.name?e.name:"no-name",t.isFront=!isFrontAndBack||e.isFront,t.originalOpacity=cropAreaOpacity,t.isFront||(t.opacity=0,t.selectable=!1),t.on("mousedown",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),t.on("scaled",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),t.on("mousemove",function(e){rectLogger(e.target)}),canvas.add(t),cropAreas.push(t)}})}e.imageFormat&&(imageFormat=e.imageFormat)}else canvas.setWidth(1024),canvas.setHeight(512);switchCropAreas(),canvas.renderAll()})}loadImageBase64(e,t){loadingAnimation(!0),t&&canvasImageFront?canvas.remove(canvasImageFront):!t&&canvasImageBack&&canvas.remove(canvasImageBack),fabric.util.loadImage(e,function(e){var a;object=new fabric.Image(e),newImageDimensions=getNewImageDimensions(object),object.set({left:0,top:0,selectable:!1}),object.hasRotatingPoint=!0,object.scaleToWidth(newImageDimensions.width),object.scaleToHeight(newImageDimensions.height),object.toObject=(a=object.toObject,function(){return fabric.util.object.extend(a.call(this),{isFront:this.isFront})}),isFrontSelected&&canvasImageFront?canvas.remove(canvasImageFront):!isFrontSelected&&canvasImageBack&&canvas.remove(canvasImageBack),object.isFront=t,(copyObject=new fabric.Image(e)).set({left:0,top:0,selectable:!1}),copyObject.hasRotatingPoint=!0,copyObject.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{isFront:this.isFront})}}(copyObject.toObject),copyObject.isFront=t,object.isFront?canvasImageFront=object:canvasImageBack=object,copyObject.isFront?copyCanvasImageFront=copyObject:copyCanvasImageBack=copyObject,switchImages(),loadingAnimation(!1)})}createButton(e,t,a,n,o){var c=document.createElement("button");c.setAttribute("id",e),c.setAttribute("class",t),c.setAttribute("type","button");var i=document.createElement("span");return i.setAttribute("class","material-icons"),i.appendChild(document.createTextNode(a)),c.appendChild(i),c.appendChild(document.createTextNode(n)),o&&c.setAttribute("onclick",o),c}addButton(e,t,a,n,o,c){var i=document.getElementById("workspace-options"),r=document.createElement("button");r.setAttribute("id",e),r.setAttribute("class",t),r.setAttribute("type","button");var s=document.createElement("span");s.setAttribute("class","material-icons"),s.appendChild(document.createTextNode(a)),r.appendChild(s),r.appendChild(document.createTextNode(n)),o&&r.addEventListener("click",o),c?i.insertBefore(r,i.firstChild):i.appendChild(r)}getImages(){return{frontImage:copyCanvasImageFront,backImage:copyCanvasImageBack}}getCroppedImages(){return croppedImages}hideCanvas(){var e=document.getElementById("workspace-area"),t=document.getElementById("workspace-switch");e.style.display="none",t.style.display="none"}showCanvas(){var e=document.getElementById("workspace-area"),t=document.getElementById("workspace-switch");e.style.display="flex",t.style.display="flex"}disableButton(e){var t=document.getElementById(e);t&&(t.disabled=!0,t.style.display="none")}enableButton(e){var t=document.getElementById(e);t&&(t.disabled=!1,t.style.display="flex")}}const addRectangle=()=>{var e=new fabric.Rect({left:10,top:10,fill:cropAreaColor,width:cropAreaWidth,height:cropAreaHeight,opacity:cropAreaOpacity});cropAreaControlsVisibility&&e.setControlsVisibility(cropAreaControlsVisibility),e.on("mousedown",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),e.on("scaled",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),e.on("mousemove",function(e){rectLogger(e.target)}),canvas.add(e),cropAreas.push(e)};function removeRectangle(){canvas.remove(selectedCropArea);var e=cropAreas.findIndex(e=>e===selectedCropArea);e>=0&&cropAreas.splice(e,1)}function removeAllImagesFromCanvas(){canvasImageFront&&canvas.remove(canvasImageFront),canvasImageBack&&canvas.remove(canvasImageBack)}var object,copyObject,newImageDimensions;function loadImage(e,t){if(loadingAnimation(!0),e.files&&e.files[0]){var a=new FileReader;a.onload=function(e){fabric.util.loadImage(e.target.result,function(e){var a;object=new fabric.Image(e),newImageDimensions=getNewImageDimensions(object),object.set({left:0,top:0,selectable:!1}),object.hasRotatingPoint=!0,object.scaleToWidth(newImageDimensions.width),object.scaleToHeight(newImageDimensions.height),object.toObject=(a=object.toObject,function(){return fabric.util.object.extend(a.call(this),{isFront:this.isFront})}),object.isFront=isFrontSelected,(copyObject=new fabric.Image(e)).set({left:0,top:0,selectable:!1}),copyObject.hasRotatingPoint=!0,copyObject.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{isFront:this.isFront})}}(copyObject.toObject),isFrontSelected&&canvasImageFront?canvas.remove(canvasImageFront):!isFrontSelected&&canvasImageBack&&canvas.remove(canvasImageBack),copyObject.isFront=isFrontSelected,object.isFront?canvasImageFront=object:canvasImageBack=object,copyObject.isFront?copyCanvasImageFront=copyObject:copyCanvasImageBack=copyObject,switchImages(),loadingAnimation(!1);var n=document.getElementById("workspace-area"),o=document.getElementById("workspace-switch");n.style.display="flex",o.style.display="flex",null!=t&&t()})};a.readAsDataURL(e.files[0])}}const crop=async()=>{croppedImages=[];var e=document.getElementById("crop-links");e&&(e.innerHTML="");var t=1;cropAreas.map(e=>{if(e.isFront&&copyCanvasImageFront||!e.isFront&&copyCanvasImageBack){var a=getRectFromOriginalImage(e);e.isFront==isFrontSelected&&e.set({opacity:0}),canvas.add(e.isFront?copyCanvasImageFront:copyCanvasImageBack);var n=canvas.toDataURL({format:imageFormat,left:a.left,top:a.top,width:a.width,height:a.height});canvas.remove(e.isFront?copyCanvasImageFront:copyCanvasImageBack),addResult(n,e.name?e.name:`Recorte ${t}`),t+=1,e.isFront==isFrontSelected&&e.set({opacity:.4})}})};function addResult(e,t){if(displayCropResults){var a=document.getElementById("crop-links"),n=document.createTextNode(t),o=document.createElement("button");o.appendChild(n),o.setAttribute("data-img",e),o.setAttribute("class","btn-link"),o.setAttribute("type","button"),o.setAttribute("onclick","displayCrop(this)"),a.appendChild(o)}croppedImages.push({name:t,base64:e})}function getNewImageDimensions(e){var t=canvasWidth*e.height/e.width;return{width:canvasWidth,height:t}}function getRectFromOriginalImage(e){return{width:copyObject.width*e.getScaledWidth()/newImageDimensions.width,height:copyObject.height*e.getScaledHeight()/newImageDimensions.height,left:copyObject.width*e.left/newImageDimensions.width,top:copyObject.height*e.top/newImageDimensions.height}}function loadingAnimation(e){const t=document.getElementsByClassName("workspace-loading")[0];t&&(t.style.display=e?"flex":"none")}const rectLogger=e=>{const t=document.getElementById("dev-area");if(t){const a=`{ isFront: ${isFrontSelected}, name: "${e.name}", x: ${e.left}, y: ${e.top}, width: ${e.getScaledWidth()}, height: ${e.getScaledHeight()} }`;t.innerText=a}};function displayCrop(e){var t=document.getElementById("crop-modal"),a=document.getElementById("crop-image-display"),n=document.createElement("img");n.setAttribute("src",e.dataset.img),a.innerHTML="",a.appendChild(n),t.classList.add("opened")}function closeDisplayModal(){document.getElementById("crop-modal").classList.remove("opened")}const switchCropAreas=()=>{cropAreas.map(e=>{e.isFront==isFrontSelected?(e.opacity=e.originalOpacity,e.selectable=!0,e.hoverCursor="all-scroll",canvas.bringToFront(e)):(e.opacity=0,e.selectable=!1,e.hoverCursor="default",canvas.sendToBack(e))}),canvas.discardActiveObject().renderAll()},switchImages=()=>{canvasImageFront&&canvas.remove(canvasImageFront),canvasImageBack&&canvas.remove(canvasImageBack),isFrontSelected&&canvasImageFront?(canvas.add(canvasImageFront),canvas.sendToBack(canvasImageFront)):!isFrontSelected&&canvasImageBack&&(canvas.add(canvasImageBack),canvas.sendToBack(canvasImageBack)),canvas.renderAll()};