var canvasWidth,canvasHeight,selectedCropArea,canvasImageFront,canvasImageBack,copyCanvasImageFront,copyCanvasImageBack,workspace=document.getElementById("workspace"),canvas=new fabric.Canvas("workspace",{selection:!1}),cropAreas=[],imageFormat="png",cropAreaWidth=100,cropAreaHeight=100,cropAreaColor="red",cropAreaOpacity=.4,isFrontSelected=!0,isFrontAndBack=!1,croppedImages=[],displayCropResults=!0;function MultiCrop(){const e=async e=>{var t=document.getElementsByClassName("workspace-container")[0],a=document.createElement("div");a.setAttribute("id","crop-modal"),a.setAttribute("class","display-crop-container"),document.createElement("span").setAttribute("class","display-crop-container");var n=document.createElement("span");n.setAttribute("class","close-display material-icons"),n.setAttribute("onclick","closeDisplayModal()"),n.appendChild(document.createTextNode("close"));var c=document.createElement("div");c.setAttribute("id","crop-image-display"),a.appendChild(n),a.appendChild(c);var o=document.createElement("div");o.setAttribute("id","workspace-area"),o.setAttribute("class","workspace-area");var i=document.createElement("textarea");i.setAttribute("id","dev-area"),i.setAttribute("class","workspace-dev-area"),i.style.width=e.width?`${e.width}px`:"100%";var s=document.createElement("div");s.setAttribute("class","workspace-loading");var r=document.createElement("div");r.setAttribute("class","lds-ellipsis"),r.appendChild(document.createElement("div")),r.appendChild(document.createElement("div")),r.appendChild(document.createElement("div")),r.appendChild(document.createElement("div")),s.appendChild(r);var d=document.createElement("canvas");d.setAttribute("id","workspace"),o.appendChild(s),o.appendChild(d);var l=document.createElement("div");l.setAttribute("class","workspace-options");var p=document.createElement("div");p.setAttribute("id","workspace-options"),p.setAttribute("class","options-row");var m=e&&e.disableButtons?e.disableButtons:[];if(m.indexOf("add-image")<0){var u=this.createButton("file-selection","btn-multicrop","add_a_photo","Carregar imagem");p.appendChild(u);var g=document.createElement("input");g.setAttribute("id","input-file-selection"),g.setAttribute("type","file"),g.style.display="none",g.addEventListener("change",function(t){loadImage(g),null!=e.imageUploadEvent&&e.imageUploadEvent()}),u.addEventListener("click",function(e){g&&g.click()},!1),p.appendChild(g)}m.indexOf("add-crop")<0&&p.appendChild(this.createButton("add-crop","btn-multicrop","crop_free","Adicionar recorte","addRectangle()")),m.indexOf("remove-crop")<0&&p.appendChild(this.createButton("remove-crop","btn-multicrop","delete","Remover recorte","removeRectangle()")),m.indexOf("crop-all")<0&&p.appendChild(this.createButton("crop","btn-multicrop","crop","Aplicar recorte","crop()")),l.appendChild(p);var h=document.createElement("div");h.setAttribute("class","workspace-results");var v=document.createElement("div");v.setAttribute("id","crop-links"),v.setAttribute("class","options-row"),h.appendChild(v);var b=document.createElement("div");b.setAttribute("id","workspace-switch"),b.setAttribute("class","options-row");var y=document.createTextNode("Frente"),A=document.createElement("button");A.appendChild(y),A.setAttribute("class","btn-front btn-switched"),A.setAttribute("type","button"),A.addEventListener("click",function(e){const t=document.getElementsByClassName("btn-back")[0];t&&t.classList.remove("btn-switched"),e.target.classList.add("btn-switched"),isFrontSelected=!0,switchCropAreas(),switchImages()},!1);var f=document.createTextNode("Verso"),C=document.createElement("button");C.appendChild(f),C.setAttribute("class","btn-back"),C.setAttribute("type","button"),C.addEventListener("click",function(e){const t=document.getElementsByClassName("btn-front")[0];t&&t.classList.remove("btn-switched"),e.target.classList.add("btn-switched"),isFrontSelected=!1,switchCropAreas(),switchImages()},!1),b.appendChild(A),b.appendChild(C),t.appendChild(a),t.appendChild(o),e.devMode&&t.appendChild(i),e.isFrontAndBack&&t.appendChild(b),t.appendChild(l),e.displayCropResults&&t.appendChild(h),workspace=document.getElementById("workspace"),canvas=new fabric.Canvas("workspace",{selection:!1})};this.loadWorkspace=(async t=>{e(t).then(()=>{t?(canvasWidth=t.width?t.width:1024,canvasHeight=t.height?t.height:512,cropAreaWidth=t.defaultCropAreaWidth?t.defaultCropAreaWidth:100,cropAreaHeight=t.defaultCropAreaHeight?t.defaultCropAreaHeight:100,cropAreaColor=t.cropAreaColor?t.cropAreaColor:"red",cropAreaOpacity=t.cropAreaOpacity?t.cropAreaOpacity:.4,null!=t.isFrontAndBack&&(isFrontAndBack=t.isFrontAndBack),canvas.setWidth(canvasWidth),canvas.setHeight(canvasHeight),null!=t.displayCropResults&&(displayCropResults=t.displayCropResults),t.initialCropAreas&&t.initialCropAreas.map(e=>{if(e.width>0&&e.height>0){var t=new fabric.Rect({left:e.x,top:e.y,fill:cropAreaColor,width:e.width,height:e.height,opacity:cropAreaOpacity,hasRotatingPoint:!1,selectable:!0});t.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{name:this.name,isFront:this.isFront,originalOpacity:this.originalOpacity})}}(t.toObject),t.name=e.name?e.name:"no-name",t.isFront=!isFrontAndBack||e.isFront,t.originalOpacity=cropAreaOpacity,t.isFront||(t.opacity=0,t.selectable=!1),t.on("mousedown",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),t.on("scaled",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),t.on("mousemove",function(e){rectLogger(e.target)}),canvas.add(t),cropAreas.push(t)}}),t.imageFormat&&(imageFormat=t.imageFormat)):(canvas.setWidth(1024),canvas.setHeight(512)),switchCropAreas(),canvas.renderAll()})}),this.loadImageBase64=function(e,t){loadingAnimation(!0),t&&canvasImageFront?canvas.remove(canvasImageFront):!t&&canvasImageBack&&canvas.remove(canvasImageBack),fabric.util.loadImage(e,function(e){var a;object=new fabric.Image(e),newImageDimensions=getNewImageDimensions(object),object.set({left:0,top:0,selectable:!1}),object.hasRotatingPoint=!0,object.scaleToWidth(newImageDimensions.width),object.scaleToHeight(newImageDimensions.height),object.toObject=(a=object.toObject,function(){return fabric.util.object.extend(a.call(this),{isFront:this.isFront})}),object.isFront=t,(copyObject=new fabric.Image(e)).set({left:0,top:0,selectable:!1}),copyObject.hasRotatingPoint=!0,copyObject.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{isFront:this.isFront})}}(copyObject.toObject),copyObject.isFront=t,object.isFront?canvasImageFront=object:canvasImageBack=object,copyObject.isFront?copyCanvasImageFront=copyObject:copyCanvasImageBack=copyObject,switchImages(),loadingAnimation(!1)})},this.createButton=function(e,t,a,n,c){var o=document.createElement("button");o.setAttribute("id",e),o.setAttribute("class",t),o.setAttribute("type","button");var i=document.createElement("span");return i.setAttribute("class","material-icons"),i.appendChild(document.createTextNode(a)),o.appendChild(i),o.appendChild(document.createTextNode(n)),c&&o.setAttribute("onclick",c),o},this.addButton=function(e,t,a,n,c,o){var i=document.getElementById("workspace-options"),s=document.createElement("button");s.setAttribute("id",e),s.setAttribute("class",t),s.setAttribute("type","button");var r=document.createElement("span");r.setAttribute("class","material-icons"),r.appendChild(document.createTextNode(a)),s.appendChild(r),s.appendChild(document.createTextNode(n)),c&&s.addEventListener("click",c),o?i.insertBefore(s,i.firstChild):i.appendChild(s)},this.getCroppedImages=function(){return croppedImages},this.hideCanvas=function(){var e=document.getElementById("workspace-area"),t=document.getElementById("workspace-switch");e.style.display="none",t.style.display="none"},this.showCanvas=function(){var e=document.getElementById("workspace-area"),t=document.getElementById("workspace-switch");e.style.display="flex",t.style.display="flex"},this.disableButton=function(e){var t=document.getElementById(e);t&&(t.disabled=!0,t.style.display="none")},this.enableButton=function(e){var t=document.getElementById(e);t&&(t.disabled=!1,t.style.display="flex")}}const addRectangle=()=>{var e=new fabric.Rect({left:10,top:10,fill:cropAreaColor,width:cropAreaWidth,height:cropAreaHeight,opacity:cropAreaOpacity,hasRotatingPoint:!1});e.on("mousedown",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),e.on("scaled",function(e){selectedCropArea=e.target,rectLogger(selectedCropArea)}),e.on("mousemove",function(e){rectLogger(e.target)}),canvas.add(e),cropAreas.push(e)};function removeRectangle(){canvas.remove(selectedCropArea);var e=cropAreas.findIndex(e=>e===selectedCropArea);e>=0&&cropAreas.splice(e,1)}function removeAllImagesFromCanvas(){canvasImageFront&&canvas.remove(canvasImageFront),canvasImageBack&&canvas.remove(canvasImageBack)}var object,copyObject,newImageDimensions;function loadImage(e){if(loadingAnimation(!0),e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){fabric.util.loadImage(e.target.result,function(e){var t;object=new fabric.Image(e),newImageDimensions=getNewImageDimensions(object),object.set({left:0,top:0,selectable:!1}),object.hasRotatingPoint=!0,object.scaleToWidth(newImageDimensions.width),object.scaleToHeight(newImageDimensions.height),object.toObject=(t=object.toObject,function(){return fabric.util.object.extend(t.call(this),{isFront:this.isFront})}),object.isFront=isFrontSelected,(copyObject=new fabric.Image(e)).set({left:0,top:0,selectable:!1}),copyObject.hasRotatingPoint=!0,copyObject.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{isFront:this.isFront})}}(copyObject.toObject),isFrontSelected&&canvasImageFront?canvas.remove(canvasImageFront):!isFrontSelected&&canvasImageBack&&canvas.remove(canvasImageBack),copyObject.isFront=isFrontSelected,object.isFront?canvasImageFront=object:canvasImageBack=object,copyObject.isFront?copyCanvasImageFront=copyObject:copyCanvasImageBack=copyObject,switchImages(),loadingAnimation(!1);var a=document.getElementById("workspace-area"),n=document.getElementById("workspace-switch");a.style.display="flex",n.style.display="flex"})};t.readAsDataURL(e.files[0])}}const crop=async()=>{croppedImages=[];var e=document.getElementById("crop-links");e&&(e.innerHTML="");var t=1;cropAreas.map(e=>{if(e.isFront&&copyCanvasImageFront||!e.isFront&&copyCanvasImageBack){var a=getRectFromOriginalImage(e);e.isFront==isFrontSelected&&e.set({opacity:0}),canvas.add(e.isFront?copyCanvasImageFront:copyCanvasImageBack);var n=canvas.toDataURL({format:imageFormat,left:a.left,top:a.top,width:a.width,height:a.height});canvas.remove(e.isFront?copyCanvasImageFront:copyCanvasImageBack),addResult(n,e.name?e.name:`Recorte ${t}`),t+=1,e.isFront==isFrontSelected&&e.set({opacity:.4})}})};function addResult(e,t){if(displayCropResults){var a=document.getElementById("crop-links"),n=document.createTextNode(t),c=document.createElement("button");c.appendChild(n),c.setAttribute("data-img",e),c.setAttribute("class","btn-link"),c.setAttribute("type","button"),c.setAttribute("onclick","displayCrop(this)"),a.appendChild(c)}croppedImages.push({name:t,base64:e})}function getNewImageDimensions(e){var t=canvasWidth*e.height/e.width;return{width:canvasWidth,height:t}}function getRectFromOriginalImage(e){return{width:copyObject.width*e.getScaledWidth()/newImageDimensions.width,height:copyObject.height*e.getScaledHeight()/newImageDimensions.height,left:copyObject.width*e.left/newImageDimensions.width,top:copyObject.height*e.top/newImageDimensions.height}}function loadingAnimation(e){const t=document.getElementsByClassName("workspace-loading")[0];t&&(t.style.display=e?"flex":"none")}const rectLogger=e=>{const t=document.getElementById("dev-area");if(t){const a=`{ isFront: ${isFrontSelected}, name: "${e.name}", x: ${e.left}, y: ${e.top}, width: ${e.getScaledWidth()}, height: ${e.getScaledHeight()} }`;t.innerText=a}};function displayCrop(e){var t=document.getElementById("crop-modal"),a=document.getElementById("crop-image-display"),n=document.createElement("img");n.setAttribute("src",e.dataset.img),a.innerHTML="",a.appendChild(n),t.classList.add("opened")}function closeDisplayModal(){document.getElementById("crop-modal").classList.remove("opened")}const switchCropAreas=()=>{cropAreas.map(e=>{e.isFront==isFrontSelected?(e.opacity=e.originalOpacity,e.selectable=!0,e.hoverCursor="all-scroll",canvas.bringToFront(e)):(e.opacity=0,e.selectable=!1,e.hoverCursor="default",canvas.sendToBack(e))}),canvas.discardActiveObject().renderAll()},switchImages=()=>{removeAllImagesFromCanvas(),isFrontSelected&&canvasImageFront?(canvas.add(canvasImageFront),canvas.sendToBack(canvasImageFront)):!isFrontSelected&&canvasImageBack&&(canvas.add(canvasImageBack),canvas.sendToBack(canvasImageBack)),canvas.renderAll()};